Import-Module AWSPowerShell

$env:path += ";c:\program Files\Amazon\AWSCLIv2"

# AWS credentials
$accesskey = ""
$secretKey = ""

# Function to fetch EC2 instances by tag key and value
function Get-EC2InstanceByTag ($region, $tagKey, $tagValue) {
    $instances = Get-EC2Instance -Region $region -ProfileName "ABC-Access" | Where-Object {
        $_.Instances.Tags | Where-Object { $_.Key -eq $tagKey -and $_.Value -eq $tagValue }
    }
    return $instances  
}

# Function to start an SSM session with port forwarding for RDP in the background
function Start-SSMSessionForInstances ($instances, $region, $accesskey, $secretKey, $startPort) {
    $currentPort = $startPort

    foreach ($instance in $instances) {
        $instanceId = $instance.Instances.InstanceId
        $instanceName = ($instance.Instances.Tags | Where-Object { $_.Key -eq 'Name' }).Value

        # Print statement to show SSM session is starting
        Write-Host "Starting SSM session for instance: $instanceName (ID: $instanceId) on port $currentPort..." -ForegroundColor Yellow
        
        # Ensure AWS CLI is configured
        aws configure set aws_access_key_id $accessKey
        aws configure set aws_secret_access_key $secretKey
        aws configure set region $region

        # Build the session command
        $sessionCommand = "aws ssm start-session --target $instanceId --document-name AWS-StartPortForwardingSession --parameters portNumber=3389,localPortNumber=$currentPort --region $region"

        # Run the command in foreground, ensure completion before next instance
        $process = Start-Process -FilePath "powershell" -ArgumentList "-Command", $sessionCommand -NoNewWindow -Wait

        # Wait briefly for the session command to be fully processed and session to establish
        Start-Sleep -Seconds 2
        Write-Host "SSM session for instance $instanceName started on port $currentPort." -ForegroundColor Green

        # Generate an RDP file for this instance
        Generate-RDPFile -instanceName $instanceName -localPort $currentPort

        # Increment the port number for the next instance
        $currentPort++
    }
}

# Function to generate an RDP file for each instance
function Generate-RDPFile ($instanceName, $localPort) {
    $rdpFileContent = @"
full address:s:localhost:$localPort
prompt for credentials:i:1
administrative session:i:1
screen mode id:i:2
"@
    $currentPath = Get-Location
    $rdpFilePath = "$currentPath\SSM_RDP_$($instanceName)_$($localPort).rdp"
    Set-Content -path $rdpFilePath -Value $rdpFileContent
    Write-Host "RDP file generated for $instanceName at $rdpFilePath." -ForegroundColor Cyan

    # Brief sleep to ensure proper logging before the next instance
    Start-Sleep -Milliseconds 500
}

# Main Execution
# Step 1: Set AWS Credentials
$region = "af-south-1"

# Set AWS credentials for the profile
Set-AWSCredential -AccessKey $accesskey -SecretKey $secretKey -StoreAS "ABC-Access"
Set-DefaultAWSRegion -Region $region

# Step 2: Get the IAM User
$iamUser = Get-IAMUser -ProfileName "ABC-Access"

# Step 3: Get the partner tag from IAM policy
$partnerTagValue = $iamUser.UserName.Substring(0, $iamUser.UserName.LastIndexOf('_'))
Write-Host "Partner: $partnerTagValue" -ForegroundColor Blue

# Step 4: Fetch EC2 instances using the partner tag
$tagKey = "partner"
$instances = Get-EC2InstanceByTag -region $region -tagKey $tagKey -tagValue $partnerTagValue

# Step 5: Display the instances found
if ($instances.Count -eq 0) {
    Write-Host "No EC2 instances found with the specified partner tag." -ForegroundColor Red
    Exit
}
Write-Host "Found the following instances tagged with '$partnerTagValue':" -ForegroundColor Blue
foreach ($instance in $instances) {
    $instanceId = $instance.Instances.InstanceId
    $instanceName = ($instance.Instances.Tags | Where-Object { $_.Key -eq 'Name' }).Value
    Write-Host "- $instanceName (Instance ID: $instanceId)" -ForegroundColor Magenta
}

# Step 6: Start SSM sessions for all instances, starting from port 9999
$startPort = 9999
Start-SSMSessionForInstances -instances $instances -region $region -accesskey $accesskey -secretKey $secretKey -startPort $startPort

# Download all generated RDP files
Write-Host "RDP files have been generated for all instances." -ForegroundColor Cyan
