import boto3
import requests
from botocore.exceptions import BotoCoreError, NoCredentialsError
import os

# Define chunk size in bytes (e.g., 100 MB per part)
CHUNK_SIZE = 100 * 1024 * 1024

def upload_large_ova_to_s3_using_multipart(url, bucket_name, s3_key):
    # Initialize S3 client
    s3_client = boto3.client('s3')

    # Create a multipart upload
    try:
        multipart_upload = s3_client.create_multipart_upload(Bucket=bucket_name, Key=s3_key)
        upload_id = multipart_upload['UploadId']
    except (BotoCoreError, NoCredentialsError) as e:
        print(f"Failed to initiate multipart upload: {e}")
        return None, None

    part_number = 1
    parts = []

    try:
        # Stream the file from the URL
        with requests.get(url, stream=True) as response:
            response.raise_for_status()
            # Use a temporary file to store the stream in chunks
            with open("temp_chunk_file", "wb") as temp_file:
                for chunk in response.iter_content(chunk_size=CHUNK_SIZE):
                    if not chunk:
                        break  # End of file

                    # Write the chunk to the temp file
                    temp_file.write(chunk)

                    # Rewind the file pointer to the start of the temp file for uploading
                    temp_file.seek(0)

                    # Upload the part
                    part_response = s3_client.upload_part(
                        Bucket=bucket_name,
                        Key=s3_key,
                        PartNumber=part_number,
                        UploadId=upload_id,
                        Body=temp_file
                    )

                    # Record the part number and ETag for completing the multipart upload
                    parts.append({
                        'PartNumber': part_number,
                        'ETag': part_response['ETag']
                    })

                    # Clear the temp file for the next chunk
                    temp_file.truncate(0)

                    part_number += 1

        # Complete the multipart upload
        s3_client.complete_multipart_upload(
            Bucket=bucket_name,
            Key=s3_key,
            UploadId=upload_id,
            MultipartUpload={'Parts': parts}
        )
        
        print(f"File uploaded successfully to s3://{bucket_name}/{s3_key}")
        # Clean up temp file
        os.remove("temp_chunk_file")
        return bucket_name, s3_key

    except (requests.exceptions.RequestException, BotoCoreError, NoCredentialsError) as e:
        print(f"Error during upload: {e}")
        # Abort multipart upload if something goes wrong
        s3_client.abort_multipart_upload(Bucket=bucket_name, Key=s3_key, UploadId=upload_id)
        return None, None

# Example usage
url = "https://example.com/path-to-large-ova-file.ova"
bucket_name = "your-s3-bucket"
s3_key = "path-in-s3/large-ova-file.ova"

result_bucket_name, result_s3_key = upload_large_ova_to_s3_using_multipart(url, bucket_name, s3_key)

if result_bucket_name and result_s3_key:
    print(f"Uploaded to Bucket: {result_bucket_name}, Key: {result_s3_key}")
else:
    print("Upload failed.")
