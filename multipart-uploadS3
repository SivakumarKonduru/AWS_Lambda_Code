import boto3
import requests
from botocore.exceptions import BotoCoreError, NoCredentialsError
import time

def upload_large_ova_to_s3_using_fileobj(url, bucket_name, s3_key, retries=3, backoff=5):
    # Initialize S3 resource
    s3 = boto3.resource('s3')

    for attempt in range(retries):
        try:
            # Stream the file from the URL
            with requests.get(url, stream=True, timeout=60) as response:
                response.raise_for_status()  # Check for HTTP errors

                # Upload the file stream directly to S3
                s3.meta.client.upload_fileobj(response.raw, bucket_name, s3_key)
                print(f"File uploaded successfully to s3://{bucket_name}/{s3_key}")
                return True  # Upload was successful, exit function

        except requests.exceptions.RequestException as e:
            print(f"Failed to download the file on attempt {attempt+1}/{retries}: {e}")
        except (BotoCoreError, NoCredentialsError) as e:
            print(f"Failed to upload the file to S3 on attempt {attempt+1}/{retries}: {e}")

        # Wait before retrying
        time.sleep(backoff)

    print("Exceeded maximum retries. Upload failed.")
    return False

# Example usage
url = "https://example.com/path-to-large-ova-file.ova"
bucket_name = "your-s3-bucket"
s3_key = "path-in-s3/large-ova-file.ova"

upload_large_ova_to_s3_using_fileobj(url, bucket_name, s3_key)
